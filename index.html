<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Language Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 768px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .chat-box {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
        }
        .ai-message {
            background-color: #e5e7eb;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .input-area {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        .input-area input {
            flex-grow: 1;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-area input:focus {
            border-color: #3b82f6;
        }
        .input-area button {
            margin-left: 0.75rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .input-area button:hover {
            background-color: #2563eb;
        }
        .loading-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1s infinite;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container">
        <header class="bg-blue-600 text-white p-4 text-center rounded-t-xl shadow-md">
            <h1 class="text-2xl font-bold">Your English Tutor</h1>
            <p class="text-sm opacity-80 mt-1">Chat to start your lesson on greetings and introductions.</p>
        </header>

        <div id="chat-box" class="chat-box">
            <!-- Initial AI message -->
            <div class="message ai-message">
                Hello! My name is Axmed. I am learning English and want to practice. Can you introduce yourself?
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script type="module">
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const chatBox = document.getElementById('chat-box');
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        // This is where we define the "lesson plan" and the model's persona
        const systemPrompt = `You are a helpful and patient English tutor for a Somali-speaking student. The student's name is Axmed, and he is a beginner. Your responses should be simple, clear, and encouraging.
        
        This lesson is about greetings and introductions. Guide Axmed through a short, natural conversation.
        
        The conversation should flow like this:
        1. Axmed says "I want to practice my English." or something similar.
        2. You introduce yourself.
        3. You ask Axmed for his name.
        4. The conversation continues with simple questions about his day, where he is from, etc.
        
        If Axmed makes a grammatical error, politely correct it and provide the correct sentence. For example, if he says "I am from Mogadishu," you can say "That's great! The correct way to say that is 'I am from Mogadishu.' In English, we use 'I am' before the city name."
        
        Keep your responses short and natural.`;
        
        let conversationHistory = [];

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');
            messageDiv.textContent = text;
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function sendMessage() {
            const userText = userInput.value.trim();
            if (userText === '') return;

            addMessage(userText, 'user');
            userInput.value = '';

            const loadingMessage = document.createElement('div');
            loadingMessage.classList.add('message', 'ai-message');
            loadingMessage.innerHTML = '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>';
            chatBox.appendChild(loadingMessage);
            chatBox.scrollTop = chatBox.scrollHeight;

            conversationHistory.push({ role: 'user', parts: [{ text: userText }] });

            const payload = {
                contents: [
                    { role: "user", parts: [{ text: systemPrompt }] },
                    ...conversationHistory
                ]
            };
            
            // To ensure the conversation flows correctly without the system prompt being repeated
            // for the model's benefit, we will only send a trimmed version of the history
            // for future calls, keeping the system prompt in the initial call.
            const conversationForNextPrompt = [...conversationHistory];

            let maxRetries = 3;
            let retryCount = 0;
            let successfulResponse = false;
            
            while (retryCount < maxRetries && !successfulResponse) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Too many requests
                            const delay = Math.pow(2, retryCount) * 1000;
                            console.log(`Rate limit hit. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    const aiResponse = candidate?.content?.parts?.[0]?.text;

                    chatBox.removeChild(loadingMessage);
                    if (aiResponse) {
                        addMessage(aiResponse, 'ai');
                        conversationHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                        // Trim history to prevent it from getting too long
                        if (conversationHistory.length > 20) {
                             conversationHistory.splice(0, conversationHistory.length - 20);
                        }
                    } else {
                        addMessage('Sorry, I couldn\'t get a response. Please try again.', 'ai');
                    }
                    successfulResponse = true;

                } catch (error) {
                    console.error('Error during API call:', error);
                    if (retryCount >= maxRetries - 1) {
                         chatBox.removeChild(loadingMessage);
                         addMessage('Sorry, an error occurred. Please check your network and try again.', 'ai');
                    }
                    retryCount++;
                }
            }
        }

        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>

</body>
</html>
